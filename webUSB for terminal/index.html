<html>
  <body>
    <p>Configuration Number</p>
    <textarea id="configuration"></textarea>
    <br>
    <p>Interface Number</p>
    <textarea id="interface"></textarea>
    <input type="submit" onclick="connectAndTrigger()" value="Trigger" />
    <p>
      Type text into box and click on submit button.
      <script>
        var device;
        var configurationUsed = 0
        var interfaceUsed = 0;

        const ESCPOS = {
          encoderText: new TextEncoder(),
          NEW_LINE: new Uint8Array([0x0d, 0x0a]),
          PARTIAL_CUT_1: new Uint8Array([0x1b, 0x69]),
          CHAR_SIZE_0: new Uint8Array([0x1d, 0x21, 0x00]),
          CHAR_SIZE_1: new Uint8Array([0x1d, 0x21, 0x01]),
          CHAR_SIZE_2: new Uint8Array([0x1d, 0x21, 0x30]),
          CHAR_SIZE_3: new Uint8Array([0x1d, 0x21, 0x31]),
          BOLD_SET: new Uint8Array([0x1b, 0x45, 0x01]),
          BOLD_RESET: new Uint8Array([0x1b, 0x45, 0x00]),
          UNDERLINE_SET: new Uint8Array([0x1b, 0x2d, 0x01]),
          UNDERLINE_RESET: new Uint8Array([0x1b, 0x2d, 0x00]),
          CENTER_JUSTIFICATION: new Uint8Array([0x1b, 0x61, 0x01]),
          LEFT_JUSTIFICATION: new Uint8Array([0x1b, 0x61, 0x00]),
          RIGHT_JUSTIFICATION: new Uint8Array([0x1b, 0x61, 0x02]),
          DRAWER_OPEN: new Uint8Array([0x1b, 0x70, 0x00, 0x32, -0x06]),

          TXT_ITALIC_OFF: new Uint8Array([0x1b, 0x45]),
          TXT_ITALIC_ON: new Uint8Array([0x1b, 0x34]),
        };

        function setup(device) {
          console.log("setup");
          return device
            .open()
            .then(() => {

              try{
                addMessage("Try selectConfiguration");
                console.log("Try selectConfiguration");
                addMessage("selectConfiguration : " + configurationUsed);
                device.selectConfiguration(configurationUsed)
              } catch (error){
                addMessage("selectConfiguration Error : " + error);
              }

            }
          )
            .then(() => {
              try {
                addMessage("Try Claim Interface");
                console.log("Try Claim Interface");

                addMessage("Claiming : " + interfaceUsed);
                device.claimInterface(interfaceUsed)
                addMessage("Claim Success");
              } catch (error) {
                addMessage("Claim Interface Error : " + error);
              }

              }

            );
        }

        function callTerminal() {
          addMessage("callTerminal");
          console.log("callTerminal");
          const fromHexString = (hexString) =>
                  new Uint8Array(
                          hexString.match(/.{1,2}/g).map((byte) => parseInt(byte, 16))
                  );

          var resetSequenceCommand = fromHexString(
                  "0240000000C9247244000091EA74D90E00000001000000010000000010100100002001000000000057100000014E61BC0000000000000000000000000000000000000004"
          )

          var paymentCommand = fromHexString(
                  "02800000001E7E2BF0000000D063D90E0000001001000000010000000040000000101001000000000057100000014E61BC000000000000000000000000000000000000000A0000000050003800000C00000001500038E803000009000000265000380121000000000000330000000000000000000000000000000000000000000000000004"
          )
          console.log("resetSequenceCommand : " + resetSequenceCommand);

          try {
            addMessage("transferOut endpointNumber: " + 0);
            device.transferOut(0, resetSequenceCommand).catch((error) => {
              console.log(error);
              addMessage("transferOut Error : " + error);
              // window.alert("transferOut : " + error);
            });
          } catch (error) {
            addMessage("Inside transferOut Error : " + error);
          }

          try {
            addMessage("transferOut endpointNumber: " + 1);
            device.transferOut(1, resetSequenceCommand).catch((error) => {
              console.log(error);
              addMessage("transferOut Error : " + error);
              // window.alert("transferOut : " + error);
            });
          } catch (error) {
            addMessage("Inside transferOut Error : " + error);
          }

          try {
            addMessage("transferOut endpointNumber: " + 2);
            device.transferOut(2, resetSequenceCommand).catch((error) => {
              console.log(error);
              addMessage("transferOut Error : " + error);
              // window.alert("transferOut : " + error);
            });
          } catch (error) {
            addMessage("Inside transferOut Error : " + error);
          }

          try {
            addMessage("transferOut endpointNumber: " + 3);
            device.transferOut(3, resetSequenceCommand).catch((error) => {
              console.log(error);
              addMessage("transferOut Error : " + error);
              // window.alert("transferOut : " + error);
            });
          } catch (error) {
            addMessage("Inside transferOut Error : " + error);
          }

          try {
            addMessage("transferOut endpointNumber: " + 4);
            device.transferOut(4, resetSequenceCommand).catch((error) => {
              console.log(error);
              addMessage("transferOut Error : " + error);
              // window.alert("transferOut : " + error);
            });
          } catch (error) {
            addMessage("Inside transferOut Error : " + error);
          }

          try {
            addMessage("transferOut endpointNumber: " + 5);
            device.transferOut(5, resetSequenceCommand).catch((error) => {
              console.log(error);
              addMessage("transferOut Error : " + error);
              // window.alert("transferOut : " + error);
            });
          } catch (error) {
            addMessage("Inside transferOut Error : " + error);
          }

          try {
            addMessage("transferOut endpointNumber: " + 6);
            device.transferOut(6, resetSequenceCommand).catch((error) => {
              console.log(error);
              addMessage("transferOut Error : " + error);
              // window.alert("transferOut : " + error);
            });
          } catch (error) {
            addMessage("Inside transferOut Error : " + error);
          }

          try {
            addMessage("transferOut endpointNumber: " + 7);
            device.transferOut(7, resetSequenceCommand).catch((error) => {
              console.log(error);
              addMessage("transferOut Error : " + error);
              // window.alert("transferOut : " + error);
            });
          } catch (error) {
            addMessage("Inside transferOut Error : " + error);
          }

          try {
            addMessage("transferOut endpointNumber: " + 8);
            device.transferOut(8, resetSequenceCommand).catch((error) => {
              console.log(error);
              addMessage("transferOut Error : " + error);
              // window.alert("transferOut : " + error);
            });
          } catch (error) {
            addMessage("Inside transferOut Error : " + error);
          }

          try {
            addMessage("transferOut endpointNumber: " + 9);
            device.transferOut(9, resetSequenceCommand).catch((error) => {
              console.log(error);
              addMessage("transferOut Error : " + error);
              // window.alert("transferOut : " + error);
            });
          } catch (error) {
            addMessage("Inside transferOut Error : " + error);
          }

          try {
            addMessage("transferOut endpointNumber: " + 10);
            device.transferOut(10, resetSequenceCommand).catch((error) => {
              console.log(error);
              addMessage("transferOut Error : " + error);
              // window.alert("transferOut : " + error);
            });
          } catch (error) {
            addMessage("Inside transferOut Error : " + error);
          }

          try {
            addMessage("transferOut endpointNumber: " + 11);
            device.transferOut(11, resetSequenceCommand).catch((error) => {
              console.log(error);
              addMessage("transferOut Error : " + error);
              // window.alert("transferOut : " + error);
            });
          } catch (error) {
            addMessage("Inside transferOut Error : " + error);
          }

          try {
            addMessage("transferOut endpointNumber: " + 12);
            device.transferOut(12, resetSequenceCommand).catch((error) => {
              console.log(error);
              addMessage("transferOut Error : " + error);
              // window.alert("transferOut : " + error);
            });
          } catch (error) {
            addMessage("Inside transferOut Error : " + error);
          }

          try {
            addMessage("transferOut endpointNumber: " + 13);
            device.transferOut(13, resetSequenceCommand).catch((error) => {
              console.log(error);
              addMessage("transferOut Error : " + error);
              // window.alert("transferOut : " + error);
            });
          } catch (error) {
            addMessage("Inside transferOut Error : " + error);
          }

          try {
            addMessage("transferOut endpointNumber: " + 14);
            device.transferOut(14, resetSequenceCommand).catch((error) => {
              console.log(error);
              addMessage("transferOut Error : " + error);
              // window.alert("transferOut : " + error);
            });
          } catch (error) {
            addMessage("Inside transferOut Error : " + error);
          }

          try {
            addMessage("transferOut endpointNumber: " + 15);
            device.transferOut(15, resetSequenceCommand).catch((error) => {
              console.log(error);
              addMessage("transferOut Error : " + error);
              // window.alert("transferOut : " + error);
            });
          } catch (error) {
            addMessage("Inside transferOut Error : " + error);
          }

          try {
            addMessage("transferOut endpointNumber: " + 16);
            device.transferOut(16, resetSequenceCommand).catch((error) => {
              console.log(error);
              addMessage("transferOut Error : " + error);
              // window.alert("transferOut : " + error);
            });
          } catch (error) {
            addMessage("Inside transferOut Error : " + error);
          }

          try {
            addMessage("transferOut endpointNumber: " + 17);
            device.transferOut(17, resetSequenceCommand).catch((error) => {
              console.log(error);
              addMessage("transferOut Error : " + error);
              // window.alert("transferOut : " + error);
            });
          } catch (error) {
            addMessage("Inside transferOut Error : " + error);
          }

          try {
            addMessage("transferOut endpointNumber: " + 18);
            device.transferOut(18, resetSequenceCommand).catch((error) => {
              console.log(error);
              addMessage("transferOut Error : " + error);
              // window.alert("transferOut : " + error);
            });
          } catch (error) {
            addMessage("Inside transferOut Error : " + error);
          }

          try {
            addMessage("transferOut endpointNumber: " + 19);
            device.transferOut(19, resetSequenceCommand).catch((error) => {
              console.log(error);
              addMessage("transferOut Error : " + error);
              // window.alert("transferOut : " + error);
            });
          } catch (error) {
            addMessage("Inside transferOut Error : " + error);
          }

          try {
            addMessage("transferOut endpointNumber: " + 20);
            device.transferOut(20, resetSequenceCommand).catch((error) => {
              console.log(error);
              addMessage("transferOut Error : " + error);
              // window.alert("transferOut : " + error);
            });
          } catch (error) {
            addMessage("Inside transferOut Error : " + error);
          }

        }

        function arrays8append(a1, a2) {
          const tmp = new Uint8Array(a1.length + a2.length);
          tmp.set(a1, 0);
          tmp.set(a2, a1.byteLength);
          return tmp;
        }

        function addMessage(str) {
          var div = document.createElement('div');
          div.innerHTML = str;
          div.style.color = 'red';

          document.body.appendChild(div);
        }

        function connectAndTrigger() {
          var numberOfinterface = document.getElementById("interface").value
          var numberofConfiguration = document.getElementById("configuration".value)
          interfaceUsed = parseInt(numberOfinterface, 10);
          configurationUsed = parseInt(numberofConfiguration,10)

          addMessage("First getDevices");
          console.log("First getDevices");
          navigator.usb
                  .getDevices()
                  .then((devices) => {
                    if (devices.length > 0) {
                      device = devices[0];
                      return setup(device);
                    }
                  })
                  .catch((error) => {
                    addMessage("getDevices : " + error);
                    console.log(error);
                  });

          if (device == null) {
            console.log("device null");
            navigator.usb
              .requestDevice({
                filters: [{ vendorId: 0x0CA6 }, { vendorId: 0x072f }],
              })
              .then((selectedDevice) => {
                device = selectedDevice;
                addMessage("Device : " + device);
                console.log(device);
                return setup(device);
              })
              .then(() => callTerminal())
              .catch((error) => {
                console.log(error);
              });
          } else {
            addMessage("device not null null");
            console.log("device not null null");
            callTerminal();
          }
        }


      </script>
    </p>
  </body>
</html>
